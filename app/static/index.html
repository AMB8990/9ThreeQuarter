<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <title>｜演唱會門票姓名媒合| 安泊空間</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --b: #1f2937;
      --m: #6b7280;
      --g: #e5e7eb;
      --a: #111827;
    }

    * {
      box-sizing: border-box
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      margin: 24px;
      color: var(--a)
    }

    h1 {
      margin: 0 0 16px
    }

    h3 {
      margin: 0 0 10px
    }

    section {
      margin-bottom: 24px
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    input,
    select,
    button,
    textarea {
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid var(--g);
      border-radius: 8px
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, .25)
    }

    button {
      background: #111827;
      color: #fff;
      border: none;
      cursor: pointer
    }

    button.ghost {
      background: #fff;
      color: #111827;
      border: 1px solid var(--g)
    }

    .muted {
      color: var(--m);
      font-size: 12px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .card {
      border: 1px solid var(--g);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0
    }

    .grid {
      display: grid;
      gap: 12px
    }

    .two {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      font-size: 12px
    }

    .bar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid var(--g);
      border-radius: 12px
    }

    .right {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .ok {
      color: #16a34a
    }

    .err {
      color: #dc2626
    }

    .hl {
      background: #fff7ed;
      border: 1px dashed #fdba74;
      padding: 8px;
      border-radius: 8px
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 8px 0
    }

    .tab {
      padding: 8px 12px;
      border: 1px solid var(--g);
      border-radius: 999px;
      background: #5f5f5f;
      cursor: pointer;
    }

    .tab.active {
      background: #64381d;
      color: #fff;
      border-color: #d5ac7c;
    }

    .tab-panel[hidden] {
      display: none
    }

    .container {
      max-width: 960px;
      margin: 16px auto;
      padding: 0 16px;
    }

    @media (max-width: 480px) {
      body {
        margin: 0;
      }

      .container {
        padding: 12px;
      }

      .appbar {
        border-radius: 0;
        padding: 10px 12px;
      }

      .appbar-right {
        display: none;
      }

      .appbar .brand {
        font-size: clamp(16px, 6vw, 18px)
      }

      .appbar .sub {
        font-size: 12px
      }

      .row {
        flex-direction: column;
        align-items: stretch
      }

      .row>* {
        width: 100%
      }

      input,
      select,
      button,
      textarea {
        width: 100%
      }

      .grid.two {
        grid-template-columns: 1fr
      }

      .card {
        padding: 10px
      }

      .mono {
        word-break: break-all;
        overflow-wrap: anywhere;
        font-size: 12px
      }
    }

    .mono {
      overflow-wrap: anywhere
    }

    .appbar {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      align-items: center;
      justify-content: center; 
      padding: 12px 16px;
      background: #694520;
      color: #ffffff; 
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
  </style>
</head>

<body>
  <header class="appbar">
    <h1 class="brand">演唱會門票大撿漏 by 安泊空間</h1>
  </header>
  <div class="container">
    <p>This is a page for people who dosen't get the ticket...QQ</p>
    <p>By Amber.L</p>
    <br>

    <div class="bar">
      <div class="right" style="flex-wrap:wrap">
        <span class="muted">Who are you | 你是誰：</span>
        <span id="whoami" class="mono muted">沒登入| nobody</span>
        <button class="ghost" onclick="clearIdentity()">登出 Log out</button>
      </div>
    </div>

    <section>
      <br>
      <h3>登入or註冊</h3>
      <div class="grid two">
        <div class="card">
          <div class="muted">有user-id,請輸入 : </div>
          <div class="row">
            <input id="bind_user_id" placeholder="00000000-1111-0000-1111-0000" style="min-width:260px" />
            <button onclick="bindUserId()">登入 Log in</button>
          </div>
        </div>
        <div class="card">
          <div class="muted">沒有user-id, 用暱稱註冊：</div>
          <div class="row">
            <input id="register_name" placeholder="李安泊" style="min-width:220px" />
            <button onclick="register()">送出</button>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h3>我有票，我要登記找同伴</h3>
      <div class="row">
        <input id="show_user_name" placeholder="擁有者暱稱" />
        <input id="tix_name" placeholder="票卷登記姓名" />
        <input id="show_name" placeholder="場次名 (ex：Twice-11/22, Once-11/23)" style="min-width:280px" />
        <button onclick="createShow()">送出</button>
      </div>
      <div class="muted">需先登入 user_id</div>
      <div id="create_msg" class="muted"></div>
    </section>

    <section>
      <h3>我沒票，我想搜尋姓名試試</h3>
      <div class="row">
        <input id="search_name" placeholder="李安泊" />
        <select id="search_field" title="搜尋欄位">
          <option value="owner">擁有者</option>
          <option value="tix">門票的登記姓名</option>
        </select>
        <label><input type="checkbox" id="exact" checked />搜尋字要完全相同嗎</label>
        <button onclick="search()">搜尋！</button>
        <button class="ghost" onclick="resetSearch()">清除</button>
      </div>
      <div id="search_results"></div>
    </section>

    <section>
      <h3>逛逛有沒有門票或留言</h3>
      <div class="tabs">
        <button class="tab active" data-tab="board" onclick="switchTab('board')">公告欄</button>
        <button class="tab" data-tab="mentions" onclick="switchTab('mentions')">被留言的門票</button>
      </div>

      <div class="row" style="margin:6px 0 10px;">
        <button class="ghost" onclick="refreshCurrentTab()">重新整理</button>
        <span class="muted">更新目前資料</span>
      </div>


      <section>
        <h3>目前等待配對的門票：</h3>
        <div class="row">
        </div>
        <div id="board"></div>
      </section>

      <div id="tab-mentions" class="tab-panel" hidden>
        <div class="hl" style="margin-bottom:10px;">
          登入/註冊後可以看到誰留言給你的門票～
        </div>
        <div id="mentions_list"></div>
      </div>
  </div>
  </section>
  <script>

    const LS = {
      userId: "nameboard:user_id",
      userName: "nameboard:user_name",
      apiBase: "nameboard:api_base"
    };

    function apiBase() {
      const saved = localStorage.getItem(LS.apiBase);
      if (saved && /^https?:\/\//.test(saved)) return saved.replace(/\/$/, '');
      // 預設同網域
      return location.origin.replace(/\/$/, '') + "/api";
    }

    function saveApiBase() {
      const v = document.getElementById('api_base').value.trim();
      if (!v) { localStorage.removeItem(LS.apiBase); }
      else { localStorage.setItem(LS.apiBase, v); }
      toast('bind_msg', '已套用 API Base：' + apiBase(), 'ok');
      refreshAll();
    }

    function identity() {
      return {
        user_id: localStorage.getItem(LS.userId) || null,
        user_name: localStorage.getItem(LS.userName) || null
      };
    }

    function setIdentity(user_id, user_name) {
      if (user_id) localStorage.setItem(LS.userId, user_id);
      if (user_name) localStorage.setItem(LS.userName, user_name);
      syncWhoAmI();
    }

    function clearIdentity() {
      localStorage.removeItem(LS.userId);
      localStorage.removeItem(LS.userName);
      syncWhoAmI();
      toast('bind_msg', '已清除身分', 'ok');
    }

    function syncWhoAmI() {
      const me = identity();
      document.getElementById('whoami').textContent =
        me.user_id ? `${me.user_name || '(未命名)'} · ${me.user_id}` : '未綁定';
      document.getElementById('viewer_name').value = me.user_name || '';
      document.getElementById('show_user_name').value = me.user_name || '';
      document.getElementById('api_base').value = localStorage.getItem(LS.apiBase) || '';
    }

    //call API here
    async function api(path, opts = {}) {
      const url = apiBase() + path;
      const res = await fetch(url, opts);
      if (!res.ok) {
        const msg = await safeText(res);
        throw new Error(`${res.status} ${res.statusText} - ${msg}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    async function safeText(res) { try { return await res.text(); } catch { return ''; } }

    async function register() {
      const name = document.getElementById('register_name').value.trim();
      if (!name) return toast('reg_msg', '請輸入姓名再繼續QQ', 'err');
      try {
        const data = await api('/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_name: name })
        });
        setIdentity(data.user_id, data.user_name);
        toast('reg_msg', `^_^註冊成功！<注意注意注意!!> 請記下你的 user_id：${data.user_id}`, 'ok');
      } catch (e) { toast('reg_msg', '註冊失敗QQ：' + e.message, 'err'); }
    }

    async function bindUserId() {
      const u = document.getElementById('bind_user_id').value.trim();
      if (!u) return toast('bind_msg', '請輸入你的user_id再繼續QQ', 'err');
      try {
        const data = await api(`/users/${encodeURIComponent(u)}`);
        setIdentity(data.user_id, data.user_name);
        toast('bind_msg', `^_^綁定成功!：${data.user_name}`, 'ok');
      } catch (e) { toast('bind_msg', '綁定失敗QQ：' + e.message, 'err'); }
    }

    async function createShow() {
      const me = identity();
      const user_name = (document.getElementById('show_user_name').value || '').trim();
      const tix_name = (document.getElementById('tix_name').value || '').trim();
      const show_name = (document.getElementById('show_name').value || '').trim();

      if (!me.user_id) return toast('create_msg', 'QQ 請先綁定或註冊 user_id', 'err');
      if (!user_name || !tix_name || !show_name) return toast('create_msg', 'QQ 請完整填寫欄位', 'err');

      try {
        const data = await api('/shows', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: me.user_id,
            user_name, tix_name, show_name
          })
        });
        document.getElementById('tix_name').value = '';
        document.getElementById('show_name').value = '';
        toast('create_msg', '^_^ 建立成功！', 'ok');
        refreshBoard();
      } catch (e) { toast('create_msg', 'QQ 建立失敗：' + e.message, 'err'); }
    }

    async function listShows() {
      return api('/shows');
    }

    async function search() {
      const name = (document.getElementById('search_name').value || '').trim();
      const field = document.getElementById('search_field').value;
      const exact = document.getElementById('exact').checked;
      if (!name) return toastBox('search_results', '請輸入姓名');
      try {
        const data = await api(`/shows/search?name=${encodeURIComponent(name)}&field=${field}&exact=${exact}`);
        renderShows(data, document.getElementById('search_results'), true);
      } catch (e) {
        toastBox('search_results', '搜尋失敗：' + e.message, true);
      }
    }

    function resetSearch() {
      document.getElementById('search_name').value = '';
      document.getElementById('search_results').innerHTML = '';
    }

    async function loadComments(showId, container) {
      const viewer = (document.getElementById('viewer_name').value || '').trim();
      try {
        const qs = viewer ? `?viewer_name=${encodeURIComponent(viewer)}` : '';
        const arr = await api(`/shows/${showId}/comments${qs}`);
        container.innerHTML = '';
        if (arr.length === 0) container.append(el('div', { className: 'muted' }, ['目前沒有您可見的留言']));
        arr.forEach(c => {
          container.append(
            el('div', { className: 'muted' }, [
              el('span', { className: 'pill' }, [c.visibility]),
              ' ', el('b', {}, [c.author_name]), '：', c.content
            ])
          );
        });
      } catch (e) {
        container.innerHTML = '';
        container.append(el('div', { className: 'err' }, ['QQ 讀取留言失敗：', e.message]));
      }
    }

    async function submitComment(showId, formEl, commentsBox) {
      const me = identity();
      const author_name = formEl.querySelector('.author').value.trim() || me.user_name || '';
      const content = formEl.querySelector('.content').value.trim();
      const visibility = formEl.querySelector('.visibility').value;
      if (!author_name || !content) return alert('QQ 請填寫留言者與內容再繼續QQ');
      try {
        await api(`/shows/${showId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            author_user_id: me.user_id || null,
            author_name, content, visibility
          })
        });
        formEl.querySelector('.content').value = '';
        loadComments(showId, commentsBox);
      } catch (e) {
        alert('QQ 留言失敗：' + e.message);
      }
    }

    function refreshCurrentTab() {
      const active = document.querySelector('.tab.active')?.dataset.tab || 'board';
      if (active === 'board') {
        refreshBoard();
      } else if (active === 'mentions') {
        loadMentions();
      }
    }

    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => (k in n) ? n[k] = v : n.setAttribute(k, v));
      (children || []).forEach(c => n.append(c));
      return n;
    }

    function renderShows(list, mount, compact) {
      mount.innerHTML = '';
      if (!list || list.length === 0) {
        mount.append(el('div', { className: 'muted' }, ['QQ 目前還沒有資料～逛逛再回來八']));
        return;
      }
      list.forEach(s => {
        const card = el('div', { className: 'card' });
        card.append(
          el('div', {}, [
            el('div', { className: 'mono' }, [`#${s.id}`]),
            el('div', {}, [el('b', {}, [s.show_name])]),
            el('div', { className: 'muted' }, [`擁有者：${s.user_name}）`]),
            el('div', { className: 'muted' }, [`票券姓名：${s.tix_name}`]),
          ])
        );
        const commentsBox = el('div');
        const form = el('div', { className: 'row', style: 'margin-top:8px;' }, [
          el('input', { className: 'author', placeholder: '留言者（預設身分）' }),
          el('input', { className: 'content', placeholder: '留言內容', style: 'min-width:220px;flex:1;' }),
          el('select', { className: 'visibility' }, [
            el('option', { value: 'public' }, ['公開']),
            el('option', { value: 'private' }, ['只給門票擁有者看'])
          ]),
          el('button', { onclick: () => submitComment(s.id, form, commentsBox) }, ['留言！'])
        ]);
        card.append(el('div', { style: 'margin:6px 0;' }, [el('span', { className: 'muted' }, ['留言：'])]), commentsBox);
        if (!compact) card.append(form);
        mount.append(card);
        loadComments(s.id, commentsBox);
      });
    }

    async function refreshBoard() {
      try {
        const data = await listShows();
        renderShows(data, document.getElementById('board'), false);
      } catch (e) {
        toastBox('board', 'QQ 讀取失敗：' + e.message, true);
      }
    }

    function toast(id, msg, type) {
      const el = document.getElementById(id); if (!el) return;
      el.className = type === 'ok' ? 'ok muted' : (type === 'err' ? 'err muted' : 'muted');
      el.textContent = msg;
    }
    function toastBox(id, msg, isErr) {
      const box = document.getElementById(id);
      box.innerHTML = '';
      box.append(el('div', { className: isErr ? 'card err' : 'card ok' }, [msg]));
    }

    function switchTab(which) {
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === which);
      });
      document.getElementById('tab-board').hidden = which !== 'board';
      document.getElementById('tab-mentions').hidden = which !== 'mentions';

      if (which === 'board') {
        refreshBoard();
      } else if (which === 'mentions') {
        loadMentions();
      }
    }

    // 判斷是否為公告欄 Tab
    function isBoardActive() {
      return document.querySelector('.tab.active')?.dataset.tab === 'board';
    }

    async function loadMentions() {
      const box = document.getElementById('mentions_list');
      box.innerHTML = '';
      const me = identity();
      if (!me.user_id) {
        box.append(el('div', { className: 'card err' }, ['請先在上方登入/註冊以綁定 user_id']));
        return;
      }

      let shows = [];
      try {
        shows = await listShows();
      } catch (e) {
        box.append(el('div', { className: 'card err' }, ['讀取票券失敗：', e.message]));
        return;
      }

      const myShows = shows.filter(s => s.user_id === me.user_id);
      if (myShows.length === 0) {
        box.append(el('div', { className: 'muted' }, ['你目前沒有登記任何票券']));
        return;
      }

      // 取得每一張票券的留言（帶 viewer_name=擁有者，可看見私訊）
      const results = await Promise.all(myShows.map(async s => {
        try {
          const cms = await api(`/shows/${s.id}/comments?viewer_name=${encodeURIComponent(s.user_name)}`);
          // 篩出「別人」的留言
          const external = cms.filter(c => {
            if (c.author_user_id && me.user_id) return c.author_user_id !== me.user_id;
            // 沒有 author_user_id 就用名字比對
            return c.author_name !== s.user_name;
          });
          return { show: s, comments: external };
        } catch (e) {
          return { show: s, comments: [], error: e.message };
        }
      }));

      const hasExternal = results.filter(r => r.comments.length > 0);

      if (hasExternal.length === 0) {
        box.append(el('div', { className: 'muted' }, ['目前沒有任何票券被別人留言']));
        return;
      }

      hasExternal.forEach(({ show, comments }) => {
        const card = el('div', { className: 'card' });
        const header = el('div', {}, [
          el('div', { className: 'mono' }, [`#${show.id}`]),
          el('div', {}, [el('b', {}, [show.show_name])]),
          el('div', { className: 'muted' }, [`擁有者：${show.user_name}（${show.user_id}）`]),
          el('div', { className: 'muted' }, [`票券姓名：${show.tix_name}`]),
          el('div', { className: 'ok' }, [`有 ${comments.length} 則來自別人的留言`]),
        ]);

        const list = el('div', { style: 'margin-top:8px;' });
        comments.slice(0, 5).forEach(c => {
          list.append(
            el('div', { className: 'muted' }, [
              el('span', { className: 'pill' }, [c.visibility]),
              ' ', el('b', {}, [c.author_name]), '：', c.content
            ])
          );
        });

        card.append(header, list);
        box.append(card);
      });
    }

    function refreshAll() { refreshCurrentTab(); }
    syncWhoAmI();
    switchTab('board');

  </script>
</body>

</html>